# clear out old installation to prevent potential libtool chmod 
# commands from failing when reinstalled by another person
rm -rf bin lib include doc share man etc libexec info

#clear out status and old SRCDIR file since re-making
rm -f status  

source rebuild_autodock
set -o verbose

echo "------ Building and Installing AUTODOCK_SCR ----------"
------ Building and Installing AUTODOCK_SCR ----------

rm -rf $AUTODOCK_SCR_linux_x86
#tar -xzvf $SW_SOURCES/vinampi/$VINAMPI_VER/$AUTODOCK_SCR_linux_x86.tgz
tar -xzvf $SW_SOURCES/vinampi/$VINAMPI_VER/autodock_vina_1_1_2_linux_x86.tgz
autodock_vina_1_1_2_linux_x86/
autodock_vina_1_1_2_linux_x86/LICENSE
autodock_vina_1_1_2_linux_x86/bin/
autodock_vina_1_1_2_linux_x86/bin/vina
autodock_vina_1_1_2_linux_x86/bin/vina_split

set +o verbose

echo "------ Building and Installing VinaMPI ----------"
------ Building and Installing VinaMPI ----------

rm -rf $VINAMPI_SCR_new2
#tar -xf $SW_SOURCES/${PACKAGE}/${VERSION}/$SRCDIR.tar.gz
tar -xzvf $SW_SOURCES/vinampi/$VINAMPI_VER/$VINAMPI_SCR.tgz
VinaMPIv2_new2/
VinaMPIv2_new2/linked.list.c
VinaMPIv2_new2/linked.list.h
VinaMPIv2_new2/Makefile
VinaMPIv2_new2/VinaMPI
VinaMPIv2_new2/scripts/
VinaMPIv2_new2/scripts/preprocess_ligands.py
VinaMPIv2_new2/scripts/preprocess_ligandsv2.py
VinaMPIv2_new2/vinampi.main.c
VinaMPIv2_new2/vinampi.main.h
VinaMPIv2_new2/vinampi.work.c
VinaMPIv2_new2/vinampi.work.h

#cd $VINAMPI_SCR_new2
cd VinaMPIv2_new2
# Change COMP to mpicc
sed -i '9 s/cc/mpicc/' Makefile
# Chnage vinampi.work.c 
sed -i '279 s/^/\/\//' vinampi.work.c
sed -i "278i  char *vina_string = \"/software/dev_tools/swtree/cs400_centos7.2_pe2016-08/vinampi/v2/centos7.2_gnu5.3.0/autodock_vina_1_1_2_linux_x86/bin/vina\"; " vinampi.work.c
# vinampi.main.h

sed -i '5 s/^/\/\//' vinampi.main.h
sed -i "6i  #include \"/software/dev_tools/swtree/cs400_centos7.2_pe2016-08/openmpi/1.10.3/centos7.2_gnu5.3.0_romio/include/mpi.h\"" vinampi.main.h

make
mpicc -lm -c vinampi.work.c
mpicc vinampi.main.o vinampi.work.o linked.list.o -o VinaMPI -lm
 >>> compiled on or-condo-login02 with  mpicc <<<
rm -f *.o

if [ $? -ne 0 ] ; then
  echo "Vinampi make failed."
  exit 1
fi



cd ../

set +o verbose
/software/dev_tools/swtree/cs400/vinampi/v2/centos7.2_gnu5.3.0/rebuild : passed (0)
